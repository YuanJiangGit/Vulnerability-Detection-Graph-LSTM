## coding:utf-8
from access_db_operate import *
import copy
import tqdm
from general_op import *
import os

if __name__ == '__main__':
    '''
    nodesrecord = []
    edgerecord = []
    #for i in range(10):
    #pdgpath = '/home/zheng/Desktop/FFmpdg/'+str(i)+'/pdg_db'
    qemuid = []
    qemulabel = dict()
    qemupath = '/home/zheng/Desktop/qemu_1/'
    pdgpath = '/home/zheng/Desktop/pdg_db_1/'
    os.walk(qemupath)
    for root, dirs, files in os.walk(qemupath):
        for file in files:
            id = file.split('_')[0]
            label = file.split('_')[1].split('.')[0]
            #id_label = {id:label}
            qemulabel[id] = label
            qemuid.append(id)
    print len(qemuid)
    for root, dirs, files in os.walk(pdgpath):
        for dir in tqdm.tqdm(dirs):
          if dir in qemuid:
            dirpath = os.path.join(root,dir)
            for roots,dirss,filess in os.walk(dirpath):
                for file in filess:
                    filepath = os.path.join(roots,file)
                    fin = open(filepath, 'rb')
                    pdg = pickle.load(fin)
                    noderecord = []
                    for i in range(pdg.vcount()):
                        d = dict()
                        #d['target'] = pdg.vs[i]['filepath'].split('_')[-1].split('.')[0]
                        d['target'] = qemulabel[dir]
                        d['order'] = i
                        d['code'] = pdg.vs[i]['code']
                        d['type'] = pdg.vs[i]['type']
                        #d['id'] = pdg.vs[0]['filepath'].split('_')[0].split('/')[-1]
                        d['id'] = dir
                        noderecord.append(d)
                    nodesrecord.append(noderecord)
                    edge = pdg.get_edgelist()
                    coo1 = []
                    coo2 = []
                    for i in range(len(edge)):
                        coo1.append(edge[i][0])
                        coo2.append(edge[i][1])
                        tuple = (coo1, coo2)
                    edgerecord.append(tuple)
          else:
              continue
    print len(nodesrecord),len(edgerecord)
    for r in nodesrecord:
        with open('/home/zheng/Desktop/composite/node.txt', 'a+') as record_file:
                for ri in r:
                    record_file.write(str(ri) + '\n')
                record_file.write('----------------finish-------------\n')

    for r in edgerecord:
        with open('/home/zheng/Desktop/composite/edge.txt', 'a+') as record_file:
                for ri in r:
                    record_file.write(str(ri) + '\n')
                record_file.write('----------------finish-------------\n')
    '''
                # with open('/home/zheng/Desktop/FFMcomposite/node.txt', 'r') as f:
                #     buf = f.read()
                # record = buf.split('----------------------------\n')
                # r = record[0]
                # r_dict = map(eval, r.split('\n')[:-1])
                # print r_dict

                # with open('/home/zheng/Desktop/FFMcomposite/edge.txt', 'r') as f:
                #     buf = f.read()
                # edgeindex = buf.split('----------------------------\n')
                # e = edgeindex[0]
                # e_dict = map(eval,e.split('\n')[:-1])
                # print e_dict[1]
                # with open('/home/zheng/Desktop/FFMcomposite/edge.txt', 'r') as f:
                #     buf = f.read()
                # valid = buf.split('\n')
                # fin = open(files,'rb')
                # pdg = pickle.load(fin)
        # for i in range(pdg.vcount()):
        #     print pdg.vs[i]['code']


    node = []
    edge = []
    fin = open('/home/zheng/Desktop/cve_pdg/pdg_db/exp_cve/ff_png_zalloc_131', 'rb')
    pdg = pickle.load(fin)
    for i in range(pdg.vcount()):
        node.append(pdg.vs[i])
    for i in range(pdg.ecount()):
        edge.append(pdg.es[i])
    edges = pdg.get_edgelist()
    with open('/home/zheng/Desktop/cve_load/node.txt', 'w') as node_file:
        for n in node:
            node_file.write(str(n)+'\n')
    with open('/home/zheng/Desktop/cve_load/edge.txt', 'w') as edge_file:
        for e in edge:
            edge_file.write(str(e)+'\n')
    with open('/home/zheng/Desktop/cve_load/edges.txt', 'w') as edge_file:
        for e in edges:
            edge_file.write(str(e)+'\n')

    # target = pdg.vs[0]['filepath'].split('_')[-1].split('.')[0]
    # id = pdg.vs[0]['filepath'].split('_')[0].split('/')[-1]
    # print id
    # edge = pdg.get_edgelist()
    # coo1 = []
    # coo2 = []
    # for i in range(len(edge)):
    #     coo1.append(edge[i][0])
    #     coo2.append(edge[i][1])
    #     tuple = (coo1,coo2)
    # print edge
    # print tuple
